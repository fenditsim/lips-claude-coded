<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Post Network Graph</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&family=DM+Sans:wght@400;500&display=swap" rel="stylesheet">
  <script src="posts.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0d0e0f;
      --surface: #161718;
      --border: #252627;
      --text: #e8e6e1;
      --text-muted: #7a7875;
      --accent: #c9a84c;
      --accent-dim: rgba(201, 168, 76, 0.12);
      --font-serif: 'Playfair Display', Georgia, serif;
      --font-mono: 'DM Mono', monospace;
      --font-sans: 'DM Sans', system-ui, sans-serif;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-sans);
      height: 100vh;
      overflow: hidden;
    }

    /* ── Header ── */
    header {
      border-bottom: 1px solid var(--border);
      padding: 0 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      height: 52px;
      position: relative;
      z-index: 20;
      background: var(--bg);
    }

    header h1 {
      font-family: var(--font-serif);
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--accent);
      letter-spacing: -0.02em;
      white-space: nowrap;
    }

    .header-sep {
      color: var(--border);
      font-size: 1rem;
      line-height: 1;
    }

    .search-wrap {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      flex: 1;
      max-width: 280px;
    }

    #search {
      flex: 1;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 5px;
      padding: 0.38rem 0.65rem;
      color: var(--text);
      font-family: var(--font-sans);
      font-size: 0.82rem;
      outline: none;
      transition: border-color 0.15s;
    }

    #search:focus { border-color: var(--accent); }
    #search::placeholder { color: var(--text-muted); }

    #search-count {
      font-family: var(--font-mono);
      font-size: 0.67rem;
      color: var(--text-muted);
      white-space: nowrap;
      min-width: 52px;
    }

    .header-right { margin-left: auto; }

    .back-link {
      font-family: var(--font-mono);
      font-size: 0.72rem;
      color: var(--text-muted);
      text-decoration: none;
      transition: color 0.15s;
      white-space: nowrap;
    }

    .back-link:hover { color: var(--accent); }

    /* ── Graph container ── */
    #graph-container {
      position: relative;
      width: 100%;
      height: calc(100vh - 52px);
    }

    #graph {
      width: 100%;
      height: 100%;
      cursor: grab;
      display: block;
    }

    #graph:active { cursor: grabbing; }

    /* ── Legend ── */
    #legend {
      position: absolute;
      bottom: 1.4rem;
      left: 1.1rem;
      background: rgba(13, 14, 15, 0.88);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.7rem 0.9rem;
      pointer-events: none;
      backdrop-filter: blur(6px);
      z-index: 10;
    }

    .legend-title {
      font-family: var(--font-mono);
      font-size: 0.58rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-muted);
      margin-bottom: 0.5rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 0.42rem;
      margin-bottom: 0.28rem;
      font-family: var(--font-mono);
      font-size: 0.62rem;
      color: #9a9693;
    }

    .legend-item:last-child { margin-bottom: 0; }

    .legend-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    /* ── Zoom controls ── */
    #zoom-controls {
      position: absolute;
      bottom: 1.4rem;
      right: 1.1rem;
      display: flex;
      flex-direction: column;
      gap: 0.3rem;
      z-index: 10;
    }

    .zoom-btn {
      width: 30px;
      height: 30px;
      background: rgba(13, 14, 15, 0.88);
      border: 1px solid var(--border);
      border-radius: 5px;
      color: var(--text-muted);
      font-size: 0.88rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: border-color 0.15s, color 0.15s;
      font-family: var(--font-mono);
      backdrop-filter: blur(6px);
    }

    .zoom-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    /* ── Tooltip ── */
    #tooltip {
      position: fixed;
      background: rgba(22, 23, 24, 0.97);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.6rem 0.8rem;
      max-width: 250px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.1s;
      z-index: 200;
      backdrop-filter: blur(6px);
    }

    #tooltip.visible { opacity: 1; }

    .tt-title {
      font-family: var(--font-serif);
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.18rem;
      line-height: 1.3;
    }

    .tt-source {
      font-size: 0.7rem;
      font-style: italic;
      color: var(--text-muted);
      margin-bottom: 0.45rem;
      line-height: 1.4;
    }

    .tt-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.22rem;
    }

    .tt-pill {
      font-family: var(--font-mono);
      font-size: 0.57rem;
      padding: 0.12rem 0.38rem;
      border-radius: 3px;
      border: 1px solid var(--border);
    }

    /* ── Detail panel ── */
    #detail-panel {
      position: fixed;
      top: 52px;
      right: 0;
      width: 800px;
      height: calc(100vh - 52px);
      background: var(--surface);
      border-left: 1px solid var(--border);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 30;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    #detail-panel.open { transform: translateX(0); }

    .panel-header {
      padding: 1.1rem 1.2rem 0.85rem;
      border-bottom: 1px solid var(--border);
      position: sticky;
      top: 0;
      background: var(--surface);
      z-index: 1;
    }

    .panel-close {
      float: right;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 1rem;
      line-height: 1;
      padding: 0;
      margin-left: 0.5rem;
      transition: color 0.15s;
    }

    .panel-close:hover { color: var(--text); }

    .panel-title {
      font-family: var(--font-serif);
      font-size: 0.98rem;
      font-weight: 600;
      color: var(--accent);
      line-height: 1.35;
      padding-right: 1.5rem;
      margin-bottom: 0.28rem;
    }

    .panel-source {
      font-size: 0.76rem;
      font-style: italic;
      color: var(--text-muted);
      line-height: 1.45;
    }

    .panel-body {
      padding: 0.95rem 1.2rem 1.5rem;
      flex: 1;
    }

    .panel-snippet {
      font-size: 0.83rem;
      line-height: 1.65;
      color: #c2beb7;
      margin-bottom: 1rem;
    }

    .panel-snippet p { margin-bottom: 0.75rem; }
    .panel-snippet p:last-child { margin-bottom: 0; }

    .section-label {
      font-family: var(--font-mono);
      font-size: 0.58rem;
      text-transform: uppercase;
      letter-spacing: 0.09em;
      color: var(--text-muted);
      margin-bottom: 0.48rem;
    }

    .panel-keywords {
      display: flex;
      flex-wrap: wrap;
      gap: 0.28rem;
      margin-bottom: 0.95rem;
    }

    .panel-kw {
      font-family: var(--font-mono);
      font-size: 0.61rem;
      padding: 0.18rem 0.48rem;
      border-radius: 3px;
      border: 1px solid var(--border);
    }

    .panel-buttons {
      display: flex;
      gap: 0.45rem;
      margin-bottom: 1.1rem;
    }

    .panel-btn {
      font-family: var(--font-mono);
      font-size: 0.67rem;
      padding: 0.38rem 0.7rem;
      border-radius: 4px;
      text-decoration: none;
      transition: border-color 0.15s, color 0.15s, background 0.15s;
      cursor: pointer;
      display: inline-block;
    }

    .panel-btn-primary {
      background: var(--accent-dim);
      border: 1px solid var(--accent);
      color: var(--accent);
    }

    .panel-btn-primary:hover {
      background: rgba(201, 168, 76, 0.2);
    }

    .panel-btn-secondary {
      background: none;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .panel-btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
    }

    .panel-divider {
      border: none;
      border-top: 1px solid var(--border);
      margin: 0.7rem 0 0.9rem;
    }

    #panel-share {
      display: flex;
      align-items: center;
      gap: 0.45rem;
      flex-wrap: wrap;
      padding: 0.75rem 0 0.85rem;
      border-top: 1px solid var(--border);
      margin-top: 0.2rem;
    }

    .panel-share-label {
      font-family: var(--font-mono);
      font-size: 0.58rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-muted);
      margin-right: 0.15rem;
    }

    .panel-share-btn {
      font-family: var(--font-mono);
      font-size: 0.63rem;
      color: var(--text-muted);
      background: none;
      border: 1px solid var(--border);
      border-radius: 3px;
      padding: 0.2rem 0.5rem;
      cursor: pointer;
      text-decoration: none;
      transition: border-color 0.15s, color 0.15s;
      white-space: nowrap;
    }

    .panel-share-btn:hover {
      border-color: var(--text-muted);
      color: var(--text);
    }

    .connected-list { list-style: none; }

    .connected-item {
      display: flex;
      align-items: flex-start;
      gap: 0.55rem;
      padding: 0.52rem 0;
      border-bottom: 1px solid rgba(37, 38, 39, 0.65);
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .connected-item:hover { opacity: 0.72; }
    .connected-item:last-child { border-bottom: none; }

    .connected-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 4px;
    }

    .connected-info { flex: 1; min-width: 0; }

    .connected-title {
      font-size: 0.78rem;
      color: var(--text);
      line-height: 1.35;
      margin-bottom: 0.12rem;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .connected-meta {
      font-family: var(--font-mono);
      font-size: 0.59rem;
      color: var(--text-muted);
    }

    /* ── Axis labels ── */
    #axis-labels {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 5;
    }

    .axis-label {
      position: absolute;
      font-family: var(--font-mono);
      font-size: 9px;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: rgba(122, 120, 117, 0.28);
    }

    .axis-left   { left: 14px;  top: 50%; transform: translateY(-50%); }
    .axis-right  { right: 14px; top: 50%; transform: translateY(-50%); }
    .axis-top    { top: 14px;   left: 50%; transform: translateX(-50%); }
    .axis-bottom { bottom: 14px; left: 50%; transform: translateX(-50%); }

    .panel-view.hidden { display: none; }

    /* ── Search results view ── */
    .sr-meta {
      font-family: var(--font-mono);
      font-size: 0.62rem;
      color: var(--text-muted);
      padding: 0.7rem 1.2rem 0.5rem;
      border-bottom: 1px solid var(--border);
    }

    .sr-list { list-style: none; }

    .sr-item {
      display: flex;
      align-items: flex-start;
      gap: 0.65rem;
      padding: 0.75rem 1.2rem;
      border-bottom: 1px solid rgba(37, 38, 39, 0.6);
      cursor: pointer;
      transition: background 0.12s;
    }

    .sr-item:hover { background: rgba(255,255,255,0.03); }
    .sr-item:last-child { border-bottom: none; }

    .sr-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
      margin-top: 5px;
    }

    .sr-info { flex: 1; min-width: 0; }

    .sr-source {
      font-size: 0.8rem;
      color: var(--text);
      line-height: 1.4;
      margin-bottom: 0.18rem;
    }

    .sr-title {
      font-family: var(--font-mono);
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-bottom: 0.32rem;
    }

    .sr-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.2rem;
    }

    .sr-pill {
      font-family: var(--font-mono);
      font-size: 0.56rem;
      padding: 0.1rem 0.35rem;
      border-radius: 3px;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    /* ── SVG elements ── */
    .node-label {
      font-family: 'DM Mono', monospace;
      font-size: 7px;
      fill: rgba(122, 120, 117, 0.75);
      pointer-events: none;
      user-select: none;
    }
  </style>
</head>
<body>

<header>
  <h1>Post Network</h1>
  <span class="header-sep">·</span>
  <div class="search-wrap">
    <input type="text" id="search" placeholder="Search posts…" autocomplete="off" spellcheck="false">
    <span id="search-count"></span>
  </div>
  <div class="header-right">
    <a href="index.html" class="back-link">← Archive</a>
  </div>
</header>

<div id="graph-container">
  <svg id="graph"></svg>

  <!-- Fixed axis labels pinned to viewport edges -->
  <div id="axis-labels">
    <div class="axis-label axis-left">← Behavioural Science</div>
    <div class="axis-label axis-right">AI & Technology →</div>
    <div class="axis-label axis-top">Cognitive / Individual ↑</div>
    <div class="axis-label axis-bottom">↓ Social / Systemic</div>
  </div>

  <div id="legend">
    <div class="legend-title">Top Keywords</div>
  </div>

  <div id="zoom-controls">
    <button class="zoom-btn" id="zoom-in" title="Zoom in">+</button>
    <button class="zoom-btn" id="zoom-out" title="Zoom out">−</button>
    <button class="zoom-btn" id="zoom-reset" title="Reset view">⊙</button>
  </div>
</div>

<div id="tooltip">
  <div class="tt-title" id="tt-title"></div>
  <div class="tt-source" id="tt-source"></div>
  <div class="tt-pills" id="tt-pills"></div>
</div>

<aside id="detail-panel">
  <div class="panel-header">
    <button class="panel-close" id="panel-close" title="Close">✕</button>
    <div class="panel-title" id="panel-title"></div>
    <div class="panel-source" id="panel-source"></div>
  </div>

  <!-- Search results view -->
  <div id="search-results-view" class="panel-view hidden">
    <div class="sr-meta" id="sr-meta"></div>
    <ul class="sr-list" id="sr-list"></ul>
  </div>

  <!-- Node detail view -->
  <div id="node-detail-view" class="panel-view">
    <div class="panel-body">
      <p class="panel-snippet" id="panel-snippet"></p>
      <div class="section-label">Keywords</div>
      <div class="panel-keywords" id="panel-keywords"></div>
      <div class="panel-buttons" id="panel-buttons"></div>
      <div id="panel-share"></div>
      <hr class="panel-divider">
      <div class="section-label" id="connections-label"></div>
      <ul class="connected-list" id="panel-connections"></ul>
    </div>
  </div>
</aside>

<script>
(function () {
  'use strict';

  // ── Data preparation ────────────────────────────────────────────────────────

  const nodes = POSTS.map((p, i) => ({ ...p, id: p.slug, _idx: i }));

  // Keyword frequency across all posts
  const kwFreq = {};
  nodes.forEach(n => n.keywords.forEach(k => { kwFreq[k] = (kwFreq[k] || 0) + 1; }));

  // Top 10 keywords sorted by frequency
  const top10 = Object.entries(kwFreq)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 10)
    .map(([key, count]) => ({ key, count }));

  const PALETTE = [
    '#ef5350', // red
    '#ff8f00', // amber
    '#66bb6a', // green
    '#26c6da', // cyan
    '#42a5f5', // blue
    '#9575cd', // purple
    '#ec407a', // pink
    '#26a69a', // teal
    '#ffa726', // orange
    '#78909c', // blue-grey
  ];

  const kwColor = Object.fromEntries(top10.map((kw, i) => [kw.key, PALETTE[i]]));
  const top10Keys = top10.map(kw => kw.key);

  function getNodeColor(node) {
    for (const k of top10Keys) {
      if (node.keywords.includes(k)) return kwColor[k];
    }
    return '#4a4b4c';
  }

  // ── Axis dimensions ─────────────────────────────────────────────────────────

  // X axis: Behavioural Science (left, −1) ↔ AI & Technology (right, +1)
  const X_RIGHT = new Set([
    'GenerativeAI','MachineLearning','AgenticAI','NeurosymbolicAI',
    'AIResearch','FutureTech','ArtificialIntelligence',
  ]);
  const X_LEFT = new Set([
    'BehaviouralScience','BehavioralScience','CognitiveScience',
    'Metacognition','ResourceRationality','OrganizationalPsychology',
  ]);

  // Y axis: Social / Systemic (bottom, −1) ↔ Cognitive / Individual (top, +1)
  const Y_TOP = new Set([
    'DecisionMaking','CognitiveDeskilling','Metacognition',
    'CognitiveScience','ResourceRationality','AIBias',
  ]);
  const Y_BOT = new Set([
    'FutureOfWork','HumanAICollaboration','HumanCenteredAI','WorkerDignity',
    'Adoption','DigitalTransformation','TechTransformation',
    'AIEthics','ResponsibleAI','OrganizationalPsychology',
  ]);

  function scoreAxis(node, posSet, negSet) {
    const p = node.keywords.filter(k => posSet.has(k)).length;
    const n = node.keywords.filter(k => negSet.has(k)).length;
    return Math.max(-1, Math.min(1, (p - n) / 3));
  }

  // Build adjacency: nodeLinks[id] = [{node, weight, shared}]
  const nodeLinks = {};
  nodes.forEach(n => { nodeLinks[n.id] = []; });

  const links = [];
  for (let i = 0; i < nodes.length; i++) {
    for (let j = i + 1; j < nodes.length; j++) {
      const shared = nodes[i].keywords.filter(k => nodes[j].keywords.includes(k));
      if (shared.length > 0) {
        links.push({ source: nodes[i].id, target: nodes[j].id, weight: shared.length, shared });
        nodeLinks[nodes[i].id].push({ node: nodes[j], weight: shared.length, shared });
        nodeLinks[nodes[j].id].push({ node: nodes[i], weight: shared.length, shared });
      }
    }
  }

  // Degree-based radius
  const degree = Object.fromEntries(nodes.map(n => [n.id, nodeLinks[n.id].length]));
  const maxDeg = Math.max(...Object.values(degree));
  const minDeg = Math.min(...Object.values(degree));

  function nodeRadius(node) {
    const d = degree[node.id];
    if (maxDeg === minDeg) return 9;
    return 5 + ((d - minDeg) / (maxDeg - minDeg)) * 13;
  }

  // ── Legend ──────────────────────────────────────────────────────────────────

  const legendEl = document.getElementById('legend');
  top10.forEach((kw, i) => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML =
      `<div class="legend-dot" style="background:${PALETTE[i]}"></div>` +
      `<span>${kw.key}</span>`;
    legendEl.appendChild(item);
  });

  // ── SVG & zoom setup ────────────────────────────────────────────────────────

  const container = document.getElementById('graph-container');
  let W = container.clientWidth;
  let H = container.clientHeight;

  const svg = d3.select('#graph');
  const zoomLayer = svg.append('g').attr('class', 'zoom-layer');

  // Axis lines – drawn first so they sit beneath everything
  const axisGroup = zoomLayer.append('g').attr('class', 'axes');
  const AXIS_SPAN = 60000;

  const axisH = axisGroup.append('line') // horizontal
    .attr('stroke', '#232425')
    .attr('stroke-width', 1)
    .attr('stroke-dasharray', '5 7');

  const axisV = axisGroup.append('line') // vertical
    .attr('stroke', '#232425')
    .attr('stroke-width', 1)
    .attr('stroke-dasharray', '5 7');

  function updateAxisLines() {
    axisH.attr('x1', W / 2 - AXIS_SPAN).attr('y1', H / 2)
         .attr('x2', W / 2 + AXIS_SPAN).attr('y2', H / 2);
    axisV.attr('x1', W / 2).attr('y1', H / 2 - AXIS_SPAN)
         .attr('x2', W / 2).attr('y2', H / 2 + AXIS_SPAN);
  }
  updateAxisLines();

  const linkGroup = zoomLayer.append('g').attr('class', 'links');
  const nodeGroup = zoomLayer.append('g').attr('class', 'nodes');
  const labelGroup = zoomLayer.append('g').attr('class', 'labels');

  const zoom = d3.zoom()
    .scaleExtent([0.08, 7])
    .on('zoom', e => zoomLayer.attr('transform', e.transform));

  svg.call(zoom);

  // Canvas click → deselect
  svg.on('click', function (e) {
    if (e.target.tagName === 'svg' || e.target.classList.contains('zoom-layer')) {
      deselectNode();
    }
  });

  document.getElementById('zoom-in').addEventListener('click', () =>
    svg.transition().duration(280).call(zoom.scaleBy, 1.4));
  document.getElementById('zoom-out').addEventListener('click', () =>
    svg.transition().duration(280).call(zoom.scaleBy, 1 / 1.4));
  document.getElementById('zoom-reset').addEventListener('click', () =>
    svg.transition().duration(500).call(zoom.transform, d3.zoomIdentity));

  // ── Force simulation ────────────────────────────────────────────────────────

  const simulation = d3.forceSimulation(nodes)
    .force('link', d3.forceLink(links).id(d => d.id).distance(75).strength(0.45))
    .force('charge', d3.forceManyBody().strength(-180))
    .force('center', d3.forceCenter(W / 2, H / 2))
    .force('collide', d3.forceCollide().radius(d => nodeRadius(d) + 5))
    .force('x', d3.forceX(d => W / 2 + scoreAxis(d, X_RIGHT, X_LEFT) * W * 0.38).strength(0.07))
    .force('y', d3.forceY(d => H / 2 - scoreAxis(d, Y_TOP, Y_BOT) * H * 0.32).strength(0.07))
    .alphaDecay(0.022);

  // ── Link rendering ──────────────────────────────────────────────────────────

  function baseLinkOpacity(w) { return Math.min(0.07 + w * 0.08, 0.52); }
  function baseLinkWidth(w) { return 0.35 + w * 0.32; }

  const linkEls = linkGroup.selectAll('line')
    .data(links)
    .join('line')
    .attr('stroke', '#3a3b3c')
    .attr('stroke-width', d => baseLinkWidth(d.weight))
    .attr('stroke-opacity', d => baseLinkOpacity(d.weight));

  // ── Node rendering ──────────────────────────────────────────────────────────

  const nodeEls = nodeGroup.selectAll('circle')
    .data(nodes)
    .join('circle')
    .attr('r', d => nodeRadius(d))
    .attr('fill', d => getNodeColor(d))
    .attr('fill-opacity', 0.82)
    .attr('stroke', d => getNodeColor(d))
    .attr('stroke-width', 1.4)
    .attr('stroke-opacity', 0.45)
    .style('cursor', 'pointer');

  // ── Label rendering ─────────────────────────────────────────────────────────

  function truncate(str, max = 20) {
    return str.length > max ? str.slice(0, max - 1) + '…' : str;
  }

  const labelEls = labelGroup.selectAll('text')
    .data(nodes)
    .join('text')
    .attr('class', 'node-label')
    .attr('text-anchor', 'middle')
    .attr('dy', d => nodeRadius(d) + 10)
    .text(d => truncate(d.source_title, 20));

  // ── Simulation tick ─────────────────────────────────────────────────────────

  simulation.on('tick', () => {
    linkEls
      .attr('x1', d => d.source.x)
      .attr('y1', d => d.source.y)
      .attr('x2', d => d.target.x)
      .attr('y2', d => d.target.y);

    nodeEls
      .attr('cx', d => d.x)
      .attr('cy', d => d.y);

    labelEls
      .attr('x', d => d.x)
      .attr('y', d => d.y);
  });

  // ── Drag ────────────────────────────────────────────────────────────────────

  nodeEls.call(
    d3.drag()
      .on('start', (e, d) => {
        if (!e.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x; d.fy = d.y;
      })
      .on('drag', (e, d) => { d.fx = e.x; d.fy = e.y; })
      .on('end', (e, d) => {
        if (!e.active) simulation.alphaTarget(0);
        d.fx = null; d.fy = null;
      })
  );

  // ── State ───────────────────────────────────────────────────────────────────

  let selectedNode = null;
  let searchQuery = '';

  function matchesSearch(node) {
    if (!searchQuery) return true;
    const q = searchQuery.toLowerCase();
    return node.title.toLowerCase().includes(q) ||
      node.source_title.toLowerCase().includes(q) ||
      node.body.toLowerCase().includes(q) ||
      node.keywords.some(k => k.toLowerCase().includes(q));
  }

  function applyVisibility() {
    const hasSearch = searchQuery.length > 0;
    const hasSel = selectedNode !== null;

    // Build sets
    let matched = null;
    if (hasSearch) {
      matched = new Set(nodes.filter(matchesSearch).map(n => n.id));
    }

    let neighbors = null;
    if (hasSel) {
      neighbors = new Set(nodeLinks[selectedNode.id].map(l => l.node.id));
    }

    // Nodes
    nodeEls
      .attr('fill-opacity', d => {
        if (hasSearch) return matched.has(d.id) ? 0.85 : 0.06;
        if (hasSel) {
          if (d.id === selectedNode.id) return 0.95;
          if (neighbors.has(d.id)) return 0.72;
          return 0.08;
        }
        return 0.82;
      })
      .attr('stroke-opacity', d => {
        if (hasSearch) return matched.has(d.id) ? 0.55 : 0.03;
        if (hasSel) {
          if (d.id === selectedNode.id) return 0.9;
          if (neighbors.has(d.id)) return 0.45;
          return 0.04;
        }
        return 0.45;
      });

    // Labels
    labelEls.attr('opacity', d => {
      if (hasSearch) return matched.has(d.id) ? 1 : 0.06;
      if (hasSel) {
        if (d.id === selectedNode.id) return 1;
        if (neighbors.has(d.id)) return 0.75;
        return 0.08;
      }
      return 1;
    });

    // Links
    linkEls.attr('stroke-opacity', d => {
      const sid = typeof d.source === 'object' ? d.source.id : d.source;
      const tid = typeof d.target === 'object' ? d.target.id : d.target;

      if (hasSearch) {
        return (matched.has(sid) && matched.has(tid)) ? baseLinkOpacity(d.weight) : 0;
      }
      if (hasSel) {
        const connected = sid === selectedNode.id || tid === selectedNode.id;
        return connected ? baseLinkOpacity(d.weight) : 0.018;
      }
      return baseLinkOpacity(d.weight);
    });

    // Search count
    const countEl = document.getElementById('search-count');
    countEl.textContent = hasSearch ? `${matched.size} of ${nodes.length}` : '';
  }

  // ── Tooltip ─────────────────────────────────────────────────────────────────

  const tooltip = document.getElementById('tooltip');
  const ttTitleEl = document.getElementById('tt-title');
  const ttSourceEl = document.getElementById('tt-source');
  const ttPillsEl = document.getElementById('tt-pills');

  function showTooltip(e, d) {
    ttTitleEl.textContent = d.title;
    ttSourceEl.textContent = d.source_title;
    ttPillsEl.innerHTML = d.keywords.map(k => {
      const c = kwColor[k];
      const style = c ? `border-color:${c};color:${c}` : 'border-color:var(--border);color:var(--text-muted)';
      return `<span class="tt-pill" style="${style}">${k}</span>`;
    }).join('');
    tooltip.classList.add('visible');
    positionTooltip(e);
  }

  function hideTooltip() { tooltip.classList.remove('visible'); }

  function positionTooltip(e) {
    const margin = 13;
    const tw = tooltip.offsetWidth || 250;
    const th = tooltip.offsetHeight || 120;
    let left = e.clientX + margin;
    let top = e.clientY + margin;
    if (left + tw > window.innerWidth - 8) left = e.clientX - tw - margin;
    if (top + th > window.innerHeight - 8) top = e.clientY - th - margin;
    tooltip.style.left = left + 'px';
    tooltip.style.top = top + 'px';
  }

  nodeEls
    .on('mouseover', showTooltip)
    .on('mousemove', (e) => positionTooltip(e))
    .on('mouseout', hideTooltip);

  // ── Node click → detail panel ────────────────────────────────────────────────

  nodeEls.on('click', function (e, d) {
    e.stopPropagation();
    hideTooltip();
    if (selectedNode === d) { deselectNode(); return; }
    selectedNode = d;
    applyVisibility();
    openPanel(d);
  });

  function deselectNode() {
    selectedNode = null;
    // If search is active, revert to search results view; else close
    if (searchQuery.length > 0) {
      showSearchResultsView();
    } else {
      closePanel();
    }
    applyVisibility();
  }

  // ── Detail panel ─────────────────────────────────────────────────────────────

  const panel = document.getElementById('detail-panel');
  const searchResultsView = document.getElementById('search-results-view');
  const nodeDetailView = document.getElementById('node-detail-view');

  document.getElementById('panel-close').addEventListener('click', () => {
    selectedNode = null;
    searchQuery = '';
    document.getElementById('search').value = '';
    closePanel();
    applyVisibility();
  });

  function showSearchResultsView() {
    const matched = nodes.filter(matchesSearch);
    document.getElementById('panel-title').textContent = 'Search Results';
    document.getElementById('panel-source').textContent = '';
    document.getElementById('sr-meta').textContent =
      `${matched.length} of ${nodes.length} posts`;

    const list = document.getElementById('sr-list');
    list.innerHTML = '';
    matched.forEach(node => {
      const li = document.createElement('li');
      li.className = 'sr-item';
      const dot = getNodeColor(node);
      const pillsHtml = node.keywords.slice(0, 4).map(k => {
        const c = kwColor[k];
        const style = c ? `border-color:${c};color:${c}` : '';
        return `<span class="sr-pill" style="${style}">${k}</span>`;
      }).join('');
      li.innerHTML =
        `<div class="sr-dot" style="background:${dot}"></div>` +
        `<div class="sr-info">` +
        `<div class="sr-source">${node.source_title}</div>` +
        `<div class="sr-title">${node.title}</div>` +
        `<div class="sr-pills">${pillsHtml}</div>` +
        `</div>`;
      li.addEventListener('click', () => {
        selectedNode = node;
        applyVisibility();
        openPanel(node);
        zoomToNode(node);
      });
      list.appendChild(li);
    });

    searchResultsView.classList.remove('hidden');
    nodeDetailView.classList.add('hidden');
    panel.classList.add('open');
  }

  function openPanel(node) {
    document.getElementById('panel-title').textContent = node.title;
    document.getElementById('panel-source').textContent = node.source_title;
    const snippetEl = document.getElementById('panel-snippet');
    snippetEl.innerHTML = node.body
      .split(/\n\n+/)
      .map(p => `<p>${p.replace(/\n/g, '<br>')}</p>`)
      .join('');

    // Keywords
    const kwEl = document.getElementById('panel-keywords');
    kwEl.innerHTML = node.keywords.map(k => {
      const c = kwColor[k];
      const style = c
        ? `border-color:${c};color:${c}`
        : 'border-color:var(--border);color:var(--text-muted)';
      return `<span class="panel-kw" style="${style}">${k}</span>`;
    }).join('');

    // Buttons
    const btnsEl = document.getElementById('panel-buttons');
    btnsEl.innerHTML = '';
    if (node.linkedin_url) {
      const a = document.createElement('a');
      a.href = node.linkedin_url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.className = 'panel-btn panel-btn-primary';
      a.textContent = 'LinkedIn';
      btnsEl.appendChild(a);
    }
    if (node.source_url) {
      const a = document.createElement('a');
      a.href = node.source_url;
      a.target = '_blank';
      a.rel = 'noopener noreferrer';
      a.className = 'panel-btn panel-btn-secondary';
      a.textContent = 'Read paper';
      btnsEl.appendChild(a);
    }

    // Share strip
    const url      = node.linkedin_url || '';
    const title    = node.source_title;
    const snippet  = node.snippet;
    const shareEl  = document.getElementById('panel-share');
    const emailHref    = `mailto:?subject=${encodeURIComponent(title)}&body=${encodeURIComponent(snippet + '\n\n' + url)}`;
    const twitterHref  = `https://x.com/intent/tweet?url=${encodeURIComponent(url)}&text=${encodeURIComponent(title)}`;
    const whatsappHref = `https://wa.me/?text=${encodeURIComponent(title + '\n\n' + url)}`;

    shareEl.innerHTML =
      `<span class="panel-share-label">Share</span>` +
      `<button class="panel-share-btn" id="ps-copy">⎘ Copy link</button>` +
      `<a class="panel-share-btn" href="${emailHref}" target="_blank" rel="noopener">✉ Email</a>` +
      `<a class="panel-share-btn" href="${twitterHref}" target="_blank" rel="noopener">✕ Twitter / X</a>` +
      `<a class="panel-share-btn" href="${whatsappHref}" target="_blank" rel="noopener">◎ WhatsApp</a>`;

    document.getElementById('ps-copy').addEventListener('click', function () {
      if (!url) return;
      navigator.clipboard.writeText(url).then(() => {
        this.textContent = '✓ Copied!';
        setTimeout(() => { this.textContent = '⎘ Copy link'; }, 1600);
      });
    });

    // Connected posts sorted by shared keyword count desc
    const conns = nodeLinks[node.id].slice().sort((a, b) => b.weight - a.weight);
    document.getElementById('connections-label').textContent =
      `Connected Posts (${conns.length})`;

    const listEl = document.getElementById('panel-connections');
    listEl.innerHTML = '';
    conns.forEach(conn => {
      const li = document.createElement('li');
      li.className = 'connected-item';
      const dot = getNodeColor(conn.node);
      li.innerHTML =
        `<div class="connected-dot" style="background:${dot}"></div>` +
        `<div class="connected-info">` +
        `<div class="connected-title">${conn.node.source_title}</div>` +
        `<div class="connected-meta">${conn.weight} shared · ${conn.shared.join(', ')}</div>` +
        `</div>`;
      li.addEventListener('click', () => {
        selectedNode = conn.node;
        applyVisibility();
        openPanel(conn.node);
        zoomToNode(conn.node);
      });
      listEl.appendChild(li);
    });

    searchResultsView.classList.add('hidden');
    nodeDetailView.classList.remove('hidden');
    panel.classList.add('open');
  }

  function closePanel() {
    panel.classList.remove('open');
    searchResultsView.classList.add('hidden');
    nodeDetailView.classList.remove('hidden');
  }

  function zoomToNode(node) {
    if (node.x == null) return;
    const scale = 1.8;
    const tx = W / 2 - node.x * scale;
    const ty = H / 2 - node.y * scale;
    svg.transition().duration(550)
      .call(zoom.transform, d3.zoomIdentity.translate(tx, ty).scale(scale));
  }

  // ── Search ────────────────────────────────────────────────────────────────────

  document.getElementById('search').addEventListener('input', function () {
    searchQuery = this.value.trim();
    applyVisibility();
    if (searchQuery.length > 0) {
      selectedNode = null;
      showSearchResultsView();
    } else {
      closePanel();
    }
  });

  // ── Resize ────────────────────────────────────────────────────────────────────

  window.addEventListener('resize', () => {
    W = container.clientWidth;
    H = container.clientHeight;
    updateAxisLines();
    simulation
      .force('center', d3.forceCenter(W / 2, H / 2))
      .force('x', d3.forceX(d => W / 2 + scoreAxis(d, X_RIGHT, X_LEFT) * W * 0.38).strength(0.07))
      .force('y', d3.forceY(d => H / 2 - scoreAxis(d, Y_TOP, Y_BOT) * H * 0.32).strength(0.07))
      .alpha(0.1)
      .restart();
  });

  // Initial state
  applyVisibility();

})();
</script>
</body>
</html>
